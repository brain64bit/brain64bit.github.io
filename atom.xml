<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[devblog of @sgt_mactavish]]></title>
  <link href="http://brain64bit.github.io/atom.xml" rel="self"/>
  <link href="http://brain64bit.github.io/"/>
  <updated>2015-04-29T00:58:46+07:00</updated>
  <id>http://brain64bit.github.io/</id>
  <author>
    <name><![CDATA[@sgt_mactavish]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    
    <title type="html"><![CDATA[Extra '\n' inside rails mailer template]]></title>
    <link href="http://brain64bit.github.io/blog/2015/04/29/extra-slash-n-inside-rails-mailer-template/"/>
    
    <updated>2015-04-29T00:21:02+07:00</updated>
    <id>http://brain64bit.github.io/blog/2015/04/29/extra-slash-n-inside-rails-mailer-template</id>
    
    <content type="html"><![CDATA[<p>When i work with the email stuff, i accidentally found problem when email template was already sent by Mandrill SMTP.
For example in my apps there is a feature to reset password, which is of course inside the email contains <strong>reset password</strong> link.</p>

<p>For securing the reset password link it must supply a params called <strong>reset_password_token</strong>. The problem found when the reset password link doesnt
work, because its always wrong redirect. Can you spot the problem ?.</p>

<pre><code>&lt;a href="http://example.com/users/password/edit?reset_password_to%20ken=asdf1234"&gt;change password&lt;/a&gt;
</code></pre>

<!-- MORE -->


<p>Accidentally the links params contains extra <strong>\n</strong>. This kind of issue with html frameworks that generate HTML with no true line breaks.
Based on <a href="https://www.ietf.org/rfc/rfc5321.txt">rfc5321</a> <strong>4.5.3.1.6.  Text Line</strong> its state :</p>

<blockquote><p>The maximum total length of a text line including the <CRLF> is 1000
octets (not counting the leading dot duplicated for transparency).</p></blockquote>

<p>Hell yeah because i&rsquo;m using SLIM for mailer template, in production SLIM compiles as a single-line by default <code>pretty: false</code> for optimization.
We can solve it by toggle the <strong>pretty</strong> option to true, see <a href="http://www.rubydoc.info/gems/slim/frames#Configuring_Slim">slim config</a>.</p>

<p>But this kind of solution will be sacrifice to other page except the mailer template not being optimized.
Instead using slim for mailer template, just use <strong>ERB</strong> so it will break every new line.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Problem using ActiveRecord #exists? in eager load resultset]]></title>
    <link href="http://brain64bit.github.io/blog/2015/03/20/problem-using-activerecord-findermethods-number-exists-in-eager-load-resultset/"/>
    
    <updated>2015-03-20T19:16:20+07:00</updated>
    <id>http://brain64bit.github.io/blog/2015/03/20/problem-using-activerecord-findermethods-number-exists-in-eager-load-resultset</id>
    
    <content type="html"><![CDATA[<p>So few weeks ago i&rsquo;ve got problem in a rails apps. New Relic reports about 500 error, where the main cause is <strong>accessing method in nil object</strong>.
Here is code snippet, causing the error :</p>

<pre><code>class User &lt; ActiveRecord::Base
  has_many :posts, -&gt; { order "created_at DESC" }

  def latest_title
    posts.exists? &amp;&amp; posts.first.title
  end
end
</code></pre>

<p>From the code above, user object have a method <strong>latest_title</strong> it just check if user has posts and fetch the first post&rsquo;s title.
But somehow its produce weird error when calls <strong>user.latest_title</strong>.</p>

<!-- MORE -->


<pre><code>undefined title of nil:NilClass
</code></pre>

<p>the <strong>posts.exists?</strong> returns true but when try accessing the first post its return nil, what a ridiculous error.
Based on error trace, i found the user object is generated by eager_load query, so the query look like this :</p>

<pre><code>users = User.includes(:posts).order(created_at: :desc).limit(10000)
</code></pre>

<p>the query eager_load <strong>posts</strong> association into user object!!!. So i found the conclusion why the error happen.</p>

<ul>
<li>users resultset are eager loaded the posts association into memory.</li>
<li>for the first time the query performed there are user who dont have posts, because using eager load the posts association stored as empty collection into user object.</li>
<li>inside <strong>#latest_title</strong> method its perform checking using <strong>exists?</strong> which is surprising to me is that exists? method <strong>always check directly to database</strong>.</li>
<li>the error come when timing of resultset generated is slightly difference with operation insertion post tho user who doesn&rsquo;t have posts. The eager load &amp; insertion happen concurrently.</li>
<li>because eager load the posts association still empty collection, but when exists? performed its directly check into database which is return true.</li>
<li>so what actually happen is like <strong>[].first.title</strong> which is produce the error :)</li>
</ul>


<p>Based on that conclusion, there are 2 options. First is do the query without eager load, second is instead use <strong>exists?</strong> please use <strong>any?</strong> which is come from ruby&rsquo;s enumerable, it doesn&rsquo;t directly check the database. And now <strong>latest_title</strong> method implementation look like:</p>

<pre><code>posts.any? &amp;&amp; posts.first.title
</code></pre>

<p>Just need to be gently and careful when using eager load.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Progressbar Upload with Refile Gem]]></title>
    <link href="http://brain64bit.github.io/blog/2015/03/03/progressbar-upload-with-refile-gem/"/>
    
    <updated>2015-03-03T23:30:07+07:00</updated>
    <id>http://brain64bit.github.io/blog/2015/03/03/progressbar-upload-with-refile-gem</id>
    
    <content type="html"><![CDATA[<p>There is a ruby gem library for file upload called <a href="https://github.com/refile/refile">refile</a>.
One of features that i like is built in javascript library, which is contains several custom DOM events.
These events also can be listen, so you can provide logic easily around file upload lifecycle process.</p>

<p>By default refile provide helpers to built UI element of file input field:</p>

<pre><code>= f.attachment_field :file_field
</code></pre>

<p>From that snippet above refile won&rsquo;t use built in javascript, to enable it just add an option called <strong>direct</strong> with true.</p>

<!-- MORE -->


<pre><code>= f.attachment_field :file_field, direct: true
</code></pre>

<p>Refile provide several events which can attached into form upload element, for attaching the events you can use <strong>addEventListener</strong> :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>form.addEventListener('upload:start', function(e){});
</span><span class='line'>form.addEventListener('upload:progress', function(e){});
</span><span class='line'>form.addEventListener('upload:success', function(e){});
</span><span class='line'>form.addEventListener('upload:complete', function(e){});
</span><span class='line'>form.addEventListener('upload:failure', function(e){});</span></code></pre></td></tr></table></div></figure>


<p>Because we focused only progressbar upload, lets construct the form to using twitter bootstrap&rsquo;s progressbar, currently i&rsquo;m using slim-template for view.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>= form_for @object, html: {class: 'form-horizontal'} do |f|
</span><span class='line'>  ...
</span><span class='line'>  .form-group
</span><span class='line'>    = f.label :file_field, class: 'col-sm-3 control-label'
</span><span class='line'>    .col-sm-7
</span><span class='line'>      = f.attachment_field :file_field, class: 'form-control', direct: true
</span><span class='line'>      #progress-bar-container.hidden
</span><span class='line'>        .progress.progress-striped
</span><span class='line'>          .progress-bar.progress-bar-info style="width: 0%"
</span><span class='line'>  ...</span></code></pre></td></tr></table></div></figure>


<p>Next lets write the javascript for calculate the progress and manipulate the UI progressbar.
We can utilize <strong>upload:progress</strong> event for this purpose.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FileUploader = {
</span><span class='line'>  init: function(){
</span><span class='line'>    var form = document.querySelector('form'),
</span><span class='line'>    form.addEventListener('upload:progress', function(event){
</span><span class='line'>      this.doProgress(event);
</span><span class='line'>    }.bind(this));
</span><span class='line'>  },
</span><span class='line'>
</span><span class='line'>  doProgress: function(event){
</span><span class='line'>    var detail = event.detail;
</span><span class='line'>    var percentage = Math.round( (detail.loaded / detail.total) * 100);
</span><span class='line'>    $('.progress-bar').css('width', percentage+'%');
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>$(document).ready(function(){
</span><span class='line'>  Object.create(FileUploader).init();
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>Finally this is our progressbar using refile gem, for more information you can read on <a href="https://github.com/refile/refile">refile</a>.</p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[Install Rmagick On OSX Yosemite]]></title>
    <link href="http://brain64bit.github.io/blog/2015/01/08/install-rmagick-on-osx-yosemite/"/>
    
    <updated>2015-01-08T23:53:22+07:00</updated>
    <id>http://brain64bit.github.io/blog/2015/01/08/install-rmagick-on-osx-yosemite</id>
    
    <content type="html"><![CDATA[<p>So i&rsquo;ve problem when installing rmagick gem in macosx yosemite, although i&rsquo;ve installed imagemagick on my system.
The problem exists when bundler try to install rmagick gem and having trouble finding <strong>MagickWand.h</strong> for building native extension.</p>

<pre><code>Can't install RMagick 2.13.2. Can't find MagickWand.h.
*** extconf.rb failed ***
Could not create Makefile due to some reason, probably lack of necessary
libraries and/or headers.  Check the mkmf.log file for more details.  You may
need configuration options.
</code></pre>

<!-- MORE -->


<p>This problem can be solved by tell explicitly to rmagick where the path of imagemagick headers file with providing configuration options on gem installation,
for example like,</p>

<pre><code>gem install rmagick --with-opt-dir=your_path --with-opt-include=your_path
</code></pre>

<p>But this problem could be solve easily by installing <a href="http://en.wikipedia.org/wiki/Pkg-config">pkgconfig</a> first before installing imagemagick. So now you can install pkgconfig first and reinstall the imagemagick.
If you&rsquo;re using <strong>Homebrew</strong></p>

<pre><code>brew install pkgconfig
brew uninstall imagemagick &amp;&amp; brew install imagemagick
</code></pre>

<p>Now after reinstallation, you can easilly install rmagick gem as usual <strong>gem install rmagick</strong></p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[ruby inject method]]></title>
    <link href="http://brain64bit.github.io/blog/2014/03/18/ruby-inject-method/"/>
    
    <updated>2014-03-18T07:23:14+07:00</updated>
    <id>http://brain64bit.github.io/blog/2014/03/18/ruby-inject-method</id>
    
    <content type="html"><![CDATA[<p>Ruby inject method is useful for combining an element inside enumerable, with binary operation and initial value.</p>

<p>For example inject method useful for accumulation in one dimensional array :</p>

<pre><code>[1,2,3].inject(0){ |initial_variable, element| element + initial_variable }
</code></pre>

<p>from above operation, 0 in inject argument is initial value of <strong>initial_variable</strong> if you forget to specify an argument in inject method by default first element in enumerable will be used as initial value.</p>

<!-- MORE -->


<p>From above example inject method will accumulate all element inside array / collection, which is :</p>

<pre><code>    [1,2,3].inject(0){ |initial_variable, element| element + initial_variable} # =&gt; same as 1+2+3 = 6
</code></pre>

<p>Another example :</p>

<pre><code>    [2,4,6,8].inject(10){ |initial, element| initial * element } # =&gt; 3840
</code></pre>

<p>Well, from above example you can simplify the operation process by giving operator symbol like <strong>:+, :*, :/</strong></p>

<pre><code>    [1,2,3].inject(:+) # =&gt; 6
    [2,4,6].inject(:*) # =&gt; 48
</code></pre>

<p>Another awesomeness inject method is you can build hash key value from multi dimensional 2xN array, for example :</p>

<pre><code>    [[:a,1],[:b,2],[:c,3]].inject({}){|init,elem| init.merge(elem.first =&gt; elem.last)  }
    # =&gt; {:a=&gt;1, :b=&gt;2, :c=&gt;3}
</code></pre>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[CarrierWave uploader for tableless model in Ruby on Rails]]></title>
    <link href="http://brain64bit.github.io/blog/2013/11/19/carrierwave-uploader-for-tableless-model-in-ruby-on-rails/"/>
    
    <updated>2013-11-19T06:57:05+07:00</updated>
    <id>http://brain64bit.github.io/blog/2013/11/19/carrierwave-uploader-for-tableless-model-in-ruby-on-rails</id>
    
    <content type="html"><![CDATA[<p>In this post i want to share my experience in implementing Carrierwave for tableless model, for example i&rsquo;ve model User :</p>

<pre><code>class User
    attr_accessor :id, :name, :avatar
    ...
end
</code></pre>

<!-- MORE -->


<p>I need to store user&rsquo;s avatar using carrierwave, in this case i create <strong>AvatarUploader</strong>, the problem is how i store avatar from instantiating User model ? If your class is subclass of ActiveRecord::Base, you can use <strong>mount_uploader</strong>
method, but if you have model like User which is not subclass of ActiveRecord::Base you will get exception :</p>

<pre><code>undefined method `mount_uploader' for User:Class
</code></pre>

<p>Based on <a href="http://carrierwave.rubyforge.org/rdoc/">carrierwave documentation</a> you can use <a href="http://carrierwave.rubyforge.org/rdoc/classes/CarrierWave/Mount.html#M000027">mount_uploader</a> if your class extend <strong>CarrierWave::Mount</strong> module and your class will have capability to store a file using instance method <code>store_(mounted_field)!</code> or <code>cache_(mounted_field)!</code>. So lets refactor our User model :</p>

<pre><code>class User
    extend CarrierWave::Mount
    attr_accessor :id, :name, :avatar
    mount_uploader :avatar, AvatarUploader
    ...
    def save
        self.store_avatar!
    end
    ...
end
</code></pre>

<p>And you can test from rails console :</p>

<pre><code>u = User.new(id:1, name:"swagger")
u.avatar = File.open(some_avatar_image_file_path)
u.save
</code></pre>

<p>from rails console, a some version of avatar will created in <strong>public/tmp/timestamp/</strong> when  you assign image file to avatar field, when method <strong>save</strong> executed it will be move to <code>public/uploads/#{model.class.to_s.underscore}/#{mounted_as}/#{model.id}</code></p>
]]></content>
    
  </entry>
  
  <entry>
    
    <title type="html"><![CDATA[add-apt-repository, server certificate verification failed]]></title>
    <link href="http://brain64bit.github.io/blog/2013/11/18/add-apt-repository/"/>
    
    <updated>2013-11-18T16:56:50+07:00</updated>
    <id>http://brain64bit.github.io/blog/2013/11/18/add-apt-repository</id>
    
    <content type="html"><![CDATA[<p>I&rsquo;ve got encountered problem when try to add new repository to ubuntu 12.04 using apt :</p>

<pre><code>Traceback (most recent call last):
    File "/usr/bin/apt-add-repository", line 125, in &lt;module&gt;
    ppa_info = get_ppa_info_from_lp(user, ppa_name)
File "/usr/lib/python2.7/dist-packages/softwareproperties/ppa.py", line 84, in get_ppa_info_from_lp
    curl.perform()
pycurl.error: (60, 'server certificate verification failed. CAfile: /etc/ssl/certs/ca-certificates.crt CRLfile: none')
</code></pre>

<!-- MORE -->


<p>this error happen since ppa.py depend on pycurl, curl trying to verify peer and host with curl.setopt(pycurl.SSL_VERIFYPEER, 1) and curl.setopt(pycurl.SSL_VERIFYHOST, 2):</p>

<pre><code>def get_ppa_info_from_lp(owner_name, ppa_name):
lp_url = LAUNCHPAD_PPA_API % (owner_name, ppa_name)
    # we ask for a JSON structure from lp_page, we could use
    # simplejson, but the format is simple enough for the regexp
    callback = CurlCallback()
    curl = pycurl.Curl()

    curl.setopt(pycurl.SSL_VERIFYPEER, 1)
    curl.setopt(pycurl.SSL_VERIFYHOST, 2)

    curl.setopt(pycurl.WRITEFUNCTION, callback.body_callback)
    # only useful for testing
    if LAUNCHPAD_PPA_CERT:
        curl.setopt(pycurl.CAINFO, LAUNCHPAD_PPA_CERT)
    curl.setopt(pycurl.URL, str(lp_url))
    curl.setopt(pycurl.HTTPHEADER, ["Accept: application/json"])
    curl.perform()
    curl.close()
    lp_page = callback.contents
    return json.loads(lp_page) 
</code></pre>

<p>from <a href="http://curl.haxx.se/libcurl/c/curl_easy_setopt.html#CURLOPTSSLVERIFYHOST">http://curl.haxx.se/libcurl/c/curl_easy_setopt.html#CURLOPTSSLVERIFYHOST</a> you can bypass this verification using pass a long set to 0 :</p>

<pre><code>...
curl.setopt(pycurl.SSL_VERIFYPEER, 0)
curl.setopt(pycurl.SSL_VERIFYHOST, 0)
...
</code></pre>
]]></content>
    
  </entry>
  
</feed>